## Let There Be Light

I moved into a place which used a remote control for turning the bedroom lights on and off. This lets me lie in bed and turn the lights off at night, however sometimes the remote control goes missing, or I forget to take it to the bed with me. It would be much more convenient if I could control it from my phone. This isn't farfetched as my phone is much smarter than a simple remote control but the problem was figuring out how the remote control talked to the light. The remote didn't have an infrared LED at the front like a TV remote control, hence I suspected it used radio. To find out which band it was using I whipped out an RTLSDR dongle I had lying around and tried the ISM bands. These are bands that are allowed for without licensing, for example the 2.4Ghz band (used for Wifi). I found that the remote was transmitting on 433.9 Mhz and used On Of Keying (OOK) modulation. My phone can't transmit on 433.9Mhz so using my phone to talk to the lights required a middleman. To get more clues I opened up the remote control and found it was 433.9Mhz transmitter connected to a simple microcontroller, there must be a receiver in the light that received the radio transmission from the remote and was connected to it's own microcontroller that turned on the light.

I had an ESP8266 and I bought a transmitter receiver pair from eBay for $4. The transmitter and receiver were both extremely easy to connect to the ESP8266, all that was needed was VCC (power), ground and a data connection. Only slightly harder was getting a library which could make the ESP8266 talk to the transmitter and receiver, the RCSwitch library made talking to them a breeze. With the receiver connected I got it to decode the transmission from the remote control, this is so I could later replicate how the transmitter was talking to the light. I blasted the remote control in front of my RTLSDR and found a 16 bit message, there were 4 bits dedicated to identifying the fan (allowing the remote to talk to 16 different fans) and a few other bits were used to tell the fan to turn off or turn on to low, medium or high or switch the light. There is no dedicated on and off button for the light, you can only switch the current state i.e. go from off to on or on to off.

With the remote codes sniffed I programmed the transmitter to repeat the codes. It worked on the first try and the light turned off and on. I now had a method of communicating with all the remote fan units, the next step was connecting my phone to the ESP. The ESP is so popular in hobbyist circles because it has inbuilt WiFi and bluetooth capability, it's trivial to get connect it to a WiFI network , just add the password and AP name. The easiest way to communicate with the ESP is via a Web server, the default one is basic and I created a page that would serve up a buttons each corresponding to a remote control button. This system worked for a while but proved to be very slow to process web page inputs and would stop working after about 20 minutes. I couldn't figure out why this was happening but I read that the async http server was much more stable and could handle more connections. I rewrote the ESP8266 web page code to use the async http server and it has been working really well since then, very responsive and hasn't stopped working.
